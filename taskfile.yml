version: "3"
output: prefixed

tasks:
  check:
    deps:
      - check:flake
      - check:nix-unit
      - check:integration-tests

  check:flake:
    cmds:
      - nix flake check
  
  check:nix-unit:
    cmds:
      - nix-unit --flake .#tests {{.CLI_ARGS}}
  
  _run-integration-test:
    internal: true
    label: "integration-test:{{.INTEGRATION_TEST}}"
    prefix: "integration-test:{{.INTEGRATION_TEST}}"
    cmds:
      - |
        cd {{.INTEGRATION_TEST}};
        git clean -fdx .;
        nix develop --no-write-lock-file --command ./test.bats

  check:integration-tests:
    vars:
      INTEGRATION_TESTS:
        sh: |
          # Find all integration test directories
          find integration-tests/ -name flake.nix -print0 | xargs -0 dirname
    deps:
      - for: { var: INTEGRATION_TESTS, split: "\n" }
        task: _run-integration-test
        vars:
          INTEGRATION_TEST: "{{.ITEM}}"
  
  ci:check:
    deps: [check]
